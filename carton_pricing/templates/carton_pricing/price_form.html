{% extends "base.html" %}
{% load static %}
{% load extra_tags %}
{% load humanize %}

{% block content %}
<h3 class="mb-3">فرم قیمت</h3>

{# پیام‌ها #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">{{ message }}</div>
  {% endfor %}
{% endif %}

{# خطاها #}
{% if errors or form.non_field_errors %}
  <div class="alert alert-danger" role="alert">
    <strong>خطا در محاسبه/اعتبارسنجی:</strong>
    <ul class="mt-2 mb-0">
      {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
      {% if errors %}
        {% for field, errs in errors.items %}
          {% if field == '__all__' %}
            {% for e in errs %}<li>{{ e }}</li>{% endfor %}
          {% else %}
            <li><strong>{{ field }}:</strong>
              <ul class="mb-0">{% for e in errs %}<li>{{ e }}</li>{% endfor %}</ul>
            </li>
          {% endif %}
        {% endfor %}
      {% endif %}
    </ul>
  </div>
{% endif %}

<form method="post" id="priceForm" class="card card-body shadow-sm mb-4" dir="rtl" novalidate>
  {% csrf_token %}
  <input type="hidden" name="stage" id="stageField" value="{{ ui_stage|default:'s1' }}"/>

  {# ───────── سربرگ: مشتری / تماس / تنظیم‌کننده ───────── #}
  <div class="row g-3 mb-2">
    <div class="col-md-4">
      <label class="form-label">مشتری</label>
      <div class="form-control-plaintext">{{ locked_customer|default:"—" }}</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">شماره تماس</label>
      <div class="form-control-plaintext" dir="ltr">{{ locked_phone|default:"—" }}</div>
    </div>
    <div class="col-md-4">
      <label class="form-label" for="{{ form.prepared_by.id_for_label }}">{{ form.prepared_by.label }}</label>
      {{ form.prepared_by }}
      {% for e in form.prepared_by.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
  </div>

  {# فیلدهای مخفی واقعی برای ارسال #}
  {{ form.customer }}
  {{ form.contact_phone }}

  {# ───────── کارت: آخرین سفارش + امروز (شمسی) ───────── #}
  <div class="card mb-3">
    <div class="card-body">
      <div class="row gy-2">
        <div class="col-md-3">
          <span class="text-muted">تاریخ آخرین سفارش:</span>
          <strong>{{ last_order_date_jalali|default:"—" }}</strong>
        </div>
        <div class="col-md-3">
          <span class="text-muted">فیِ آخرین سفارش:</span>
          <strong>{{ last_order_price|default:0|floatformat:0|intcomma }}</strong>
        </div>
        <div class="col-md-3">
          <span class="text-muted">نرخ آخرین سفارش:</span>
          <strong>{{ last_order_fee|default:0|floatformat:0|intcomma }}</strong>
        </div>
        <div class="col-md-3">
          <span class="text-muted">تاریخ ثبت سفارش جدید:</span>
          <strong>{{ today_jalali }}</strong>
        </div>
      </div>
    </div>
  </div>

  {# ───────── کارت: چک‌باکس‌های انتخابی ───────── #}
  <div class="card mb-3">
    <div class="card-header">موارد انتخابی</div>
    <div class="card-body">
      <div class="row row-cols-2 row-cols-md-3 g-2">
        <label class="form-check col">{{ form.has_print_notes_bool }} <span class="ms-1">{{ form.has_print_notes_bool.label }}</span></label>

        <label class="form-check col">{{ form.flag_customer_dims }} <span class="ms-1">ابعاد مشتری</span></label>
        <label class="form-check col">{{ form.flag_customer_sample }} <span class="ms-1">نمونه مشتری</span></label>
        <label class="form-check col">{{ form.flag_sample_dims }} <span class="ms-1">ابعاد نمونه</span></label>

        <label class="form-check col">{{ form.flag_new_cliche }} <span class="ms-1">کلیشه جدید</span></label>
        <label class="form-check col">{{ form.flag_staple }} <span class="ms-1">منگنه</span></label>
        <label class="form-check col">{{ form.flag_handle_slot }} <span class="ms-1">جای دسته</span></label>
        <label class="form-check col">{{ form.flag_punch }} <span class="ms-1">پانچ</span></label>
        <label class="form-check col">{{ form.flag_pallet_wrap }} <span class="ms-1">پالت‌کشی</span></label>
        <label class="form-check col">{{ form.flag_shipping_not_seller }} <span class="ms-1">هزینه حمل بر عهده فروشنده نیست</span></label>
      </div>
    </div>
  </div>

  {# ───────── مشخصات محصول و تیراژ ───────── #}
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label" for="{{ form.product_code.id_for_label }}">{{ form.product_code.label }}</label>
      {{ form.product_code }}
      {% for e in form.product_code.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.carton_type.id_for_label }}">{{ form.carton_type.label }}</label>
      {{ form.carton_type }}
      {% for e in form.carton_type.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.carton_name.id_for_label }}">{{ form.carton_name.label }}</label>
      {{ form.carton_name }}
      {% for e in form.carton_name.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.I8_qty.id_for_label }}">{{ form.I8_qty.label }}</label>
      {{ form.I8_qty }}
      {% for e in form.I8_qty.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── A6 ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A1_layers.id_for_label }}">{{ form.A1_layers.label }}</label>
      {{ form.A1_layers }}
      {% for e in form.A1_layers.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A2_pieces.id_for_label }}">{{ form.A2_pieces.label }}</label>
      {{ form.A2_pieces }}
      {% for e in form.A2_pieces.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A3_door_type.id_for_label }}">{{ form.A3_door_type.label }}</label>
      {{ form.A3_door_type }}
      {% for e in form.A3_door_type.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A4_door_count.id_for_label }}">{{ form.A4_door_count.label }}</label>
      {{ form.A4_door_count }}
      {% for e in form.A4_door_count.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── ابعاد ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.E15_len.id_for_label }}">{{ form.E15_len.label }}</label>
      {{ form.E15_len }}
      {% for e in form.E15_len.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.G15_wid.id_for_label }}">{{ form.G15_wid.label }}</label>
      {{ form.G15_wid }}
      {% for e in form.G15_wid.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.I15_hgt.id_for_label }}">{{ form.I15_hgt.label }}</label>
      {{ form.I15_hgt }}
      {% for e in form.I15_hgt.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── لب‌ها برای «درب باز» ── #}
    <div class="col-md-3 open-door-extra d-none" id="field-e17-wrap">
      <label class="form-label" for="{{ form.E17_lip.id_for_label }}">{{ form.E17_lip.label }}</label>
      {{ form.E17_lip }}
      {% for e in form.E17_lip.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3 open-door-extra d-none" id="field-open-bottom-door">
      <label class="form-label" for="{{ form.open_bottom_door.id_for_label }}">{{ form.open_bottom_door.label }}</label>
      {{ form.open_bottom_door }}
      {% for e in form.open_bottom_door.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── هزینه‌های سربار (اختیاری) ── #}
    <div class="col-12">
      <div class="card mt-2">
        <div class="card-header">هزینه‌های سربار (اختیاری)</div>
        <div class="card-body">
         <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2">
  {% for oh in overheads %}
    <label class="form-check col d-flex align-items-center gap-2">
      <input class="form-check-input"
             type="checkbox"
             name="oh_{{ oh.id }}"
             value="1"
             {% if oh.id in overheads_checked %}checked{% endif %}>
      <span class="ms-1">
        {{ oh.name }}
        <span class="text-muted small">— {{ oh.unit_cost|default:0|intcomma0 }}</span>
      </span>
    </label>
  {% empty %}
    <div class="text-muted">هیچ هزینهٔ سرباری ثبت نشده است.</div>
  {% endfor %}
</div>
        </div>
      </div>
    </div>

    {# ───────── دکمه محاسبه جدول (قبل از نمایش جدول) ───────── #}
    <div class="text-end mt-3">
      <button class="btn btn-outline-primary" type="submit" data-stage="s1" formnovalidate>
        محاسبه جدول
      </button>
    </div>

    {# ───────── جدول انتخاب عرض ورق ───────── #}
    {% if best_by_width %}
      <div class="card mt-3">
        <div class="card-header">انتخاب عرض ورق از بین گزینه‌های مناسب</div>
        <div class="card-body">
          <p class="text-muted mb-2">
            <strong>K15 = {{ result_preview.K15 }}</strong> |
            <strong>E20 = {{ result_preview.E20 }}</strong> |
            <strong>K20 = {{ result_preview.K20 }}</strong><br>
            معیار رنگ: <span class="text-success fw-bold">سبز</span> ⇐ 0 &lt; دورریز &lt; 11 ،
            <span class="text-danger fw-bold">قرمز</span> ⇐ سایر حالات (شامل 0 و 11).
          </p>

          <div class="table-responsive">
            <table class="table table-sm align-middle text-center">
              <thead>
                <tr>
                  <th>انتخاب</th>
                  <th>(cm) عرض ورق (M24)</th>
                  <th>F24 (≤ 30)</th>
                  <th>(cm) دورریز (I22)</th>
                  <th>(cm²) مصرف کارتن (E28)</th>
                </tr>
              </thead>
              <tbody>
              {% for r in best_by_width %}
                <tr>
                  <td>
                    <input type="radio" name="sheet_choice" value="{{ r.sheet_width }}"
                           {% if request.POST.sheet_choice %}
                             {% if request.POST.sheet_choice|floatformat:2 == r.sheet_width|floatformat:2 %}checked{% endif %}
                           {% elif forloop.first %}checked{% endif %}>
                  </td>
                  <td>{{ r.sheet_width|floatformat:0 }}</td>
                  <td>{{ r.f24 }}</td>
                  <td class="{% if r.I22 is not None and r.I22 > 0 and r.I22 < 11 %}text-success fw-bold{% elif r.I22 is not None %}text-danger{% else %}text-muted{% endif %}">
                    {% if r.I22 is not None %}{{ r.I22|floatformat:2 }}{% else %}—{% endif %}
                  </td>
                  <td>{% if r.E28 is not None %}{{ r.E28|floatformat:4 }}{% else %}—{% endif %}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

    {# ── گام فلوت ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.D31_flute.id_for_label }}">{{ form.D31_flute.label }}</label>
      {{ form.D31_flute }}
      {% for e in form.D31_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
  </div>

  {# ───────── ترکیب کاغذ ───────── #}
  <div class="card mt-2">
    <div class="card-header">ترکیب کاغذ</div>
    <div class="card-body row g-3">
      <div class="col-md-4" id="wrap-glue">
        <label class="form-label" for="{{ form.pq_glue_machine.id_for_label }}">{{ form.pq_glue_machine.label }}</label>
        {{ form.pq_glue_machine }}
        {% for e in form.pq_glue_machine.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4" id="wrap-be">
        <label class="form-label" for="{{ form.pq_be_flute.id_for_label }}">{{ form.pq_be_flute.label }}</label>
        {{ form.pq_be_flute }}
        {% for e in form.pq_be_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4" id="wrap-mid">
        <label class="form-label" for="{{ form.pq_middle_layer.id_for_label }}">{{ form.pq_middle_layer.label }}</label>
        {{ form.pq_middle_layer }}
        {% for e in form.pq_middle_layer.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4" id="wrap-c">
        <label class="form-label" for="{{ form.pq_c_flute.id_for_label }}">{{ form.pq_c_flute.label }}</label>
        {{ form.pq_c_flute }}
        {% for e in form.pq_c_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-4" id="wrap-bottom">
        <label class="form-label" for="{{ form.pq_bottom_layer.id_for_label }}">{{ form.pq_bottom_layer.label }}</label>
        {{ form.pq_bottom_layer }}
        {% for e in form.pq_bottom_layer.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  {# دکمه محاسبه نهایی #}
  <div class="mt-3">
    <button id="btnSubmit" class="btn btn-primary" type="submit" data-stage="final">
      <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      محاسبه
    </button>
  </div>

  {# ───────── نتیجه ───────── #}
  {% if ui_stage == 'final' %}
    <div class="card shadow-sm">
      <div class="card-header">نتیجه محاسبات</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2"><strong>A6:</strong> {{ result.A6_sheet_code }}</div>
          <div class="col-md-2"><strong>E20:</strong> {{ result.E20_industrial_len }} cm</div>
          <div class="col-md-2"><strong>K20:</strong> {{ result.K20_industrial_wid }} cm</div>
          <div class="col-md-3"><strong>F24 (تعداد/ورق):</strong> {{ result.F24_per_sheet_count }}</div>
          <div class="col-md-3"><strong>عرض ورق انتخابی:</strong> {{ result.chosen_sheet_width }} cm</div>
          <hr/>
          <div class="col-md-3"><strong>E28 مصرف کارتن:</strong> {{ result.E28_carton_consumption }}</div>
          <div class="col-md-3"><strong>E38 متراژ ورق (m²):</strong> {{ result.E38_sheet_area_m2 }}</div>
          <div class="col-md-3"><strong>I38 تعداد ورق:</strong> {{ result.I38_sheet_count }}</div>

         <div class="col-md-3"><strong>E41 مایه کاری ورق:</strong> {{ result.E41_sheet_working_cost|intcomma0 }}</div>
<div class="col-md-3"><strong>E40 مایه کاری سربار:</strong> {{ result.E40_overhead_cost|intcomma0 }}</div>
<div class="col-md-3"><strong>M40 مایه کاری کلی:</strong> {{ result.M40_total_cost|intcomma0 }}</div>
<div class="col-md-3"><strong>M41 مبلغ سود:</strong> {{ result.M41_profit_amount|intcomma0 }}</div>
<div class="col-md-3"><strong>H46 قیمت بدون مالیات:</strong> {{ result.H46_price_before_tax|intcomma0 }}</div>
<div class="col-md-3"><strong>J48 مالیات:</strong> {{ result.J48_tax|intcomma0 }}</div>
<div class="col-md-3"><strong>E48 قیمت با مالیات:</strong> {{ result.E48_price_with_tax|intcomma0 }}</div>
<div class="col-md-3"><strong>فی ورق (Fee_amount):</strong> {{ fee_amount|default:0|intcomma0 }}</div>

        </div>
      </div>
    </div>

    {# ذخیره رکورد #}
    <div class="form-check mt-3">
      {{ form.save_record }} {{ form.save_record.label_tag }}
    </div>

    <div class="mt-3">
      <button id="btnSubmit" class="btn btn-primary" type="submit" data-stage="final">
        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        محاسبه نهایی
      </button>
    </div>
  {% endif %}
</form>

{# اگر خواستی جدول ریز لایه‌ها را برگردانی، همین‌جا است (فعلاً کامنت) #}

<script>
(function () {
  "use strict";

  // ===== درب باز (مثل قبل) =====
  function toggleOpenDoorExtras(show) {
    document.querySelectorAll('.open-door-extra').forEach(el=>{
      el.classList.toggle('d-none', !show);
    });
    if(!show){
      const e17 = document.getElementById('id_E17_lip');
      const obd = document.getElementById('id_open_bottom_door');
      if(e17) e17.value = '';
      if(obd) obd.value = '';
    }
  }
  function isOpenDoorSelected() {
    const sel = document.getElementById('id_A3_door_type');
    if(!sel) return false;
    const val = (sel.value || '').trim();
    const txt = (sel.options[sel.selectedIndex]?.text || '').replace(/\s+/g,'').trim();
    return val === '1' || txt.includes('دربباز');
  }
  function updateByA3(){ toggleOpenDoorExtras(isOpenDoorSelected()); }

  // ===== گام فلوت ⇒ نمایش ستون‌های ترکیب کاغذ =====
  function showWrap(id, show){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle('d-none', !show);
    el.querySelectorAll('select, input, textarea').forEach(ctrl => ctrl.disabled = !show);
  }

  function currentFluteText(){
    const sel = document.getElementById('id_D31_flute');
    if(!sel) return '';
    const txt = (sel.options[sel.selectedIndex]?.text || '').toUpperCase();
    return txt.replace(/\s+/g,'').trim();
  }

  function updateFluteColumns(){
    const t = currentFluteText();
    let showGlue=true, showBE=true, showMid=true, showC=true, showBottom=true;

    if (/(^|[^A-Z])C([^A-Z]|$)/.test(t)) {
      showGlue = true; showC = true; showBottom = true;
      showBE = false;  showMid = false;
    }
    else if (/(^|[^A-Z])D([^A-Z]|$)/.test(t)) {
      showGlue = true; showBE = true; showBottom = true;
      showC = false;   showMid = false;
    }
    else if (/(^|[^A-Z])E([^A-Z]|$)/.test(t)) {
      showGlue = true; showBE = true; showBottom = true;
      showC = false;   showMid = false;
    }
    else if (/(^|[^A-Z])B([^A-Z]|$)/.test(t)) {
      showGlue = true; showBE = true; showBottom = true;
      showC = false;   showMid = false;
    }

    showWrap('wrap-glue',   showGlue);
    showWrap('wrap-be',     showBE);
    showWrap('wrap-mid',    showMid);
    showWrap('wrap-c',      showC);
    showWrap('wrap-bottom', showBottom);
  }

  // ذخیره مرحله
  const stageField = document.getElementById('stageField');
  document.querySelectorAll('button[type="submit"][data-stage]').forEach(btn=>{
    btn.addEventListener('click', ()=> { if(stageField) stageField.value = btn.dataset.stage; });
  });

  // UX ارسال
  const btnSubmit = document.getElementById('btnSubmit');
  const btnSpinner = document.getElementById('btnSpinner');
  document.getElementById('priceForm')?.addEventListener('submit', ()=>{
    btnSpinner?.classList.remove('d-none');
    btnSubmit?.setAttribute('disabled','disabled');
  });

  window.addEventListener('load', function(){
    updateByA3();
    updateFluteColumns();
  });

  document.getElementById('id_A3_door_type')?.addEventListener('change', updateByA3);

  const d31 = document.getElementById('id_D31_flute');
  d31?.addEventListener('change', updateFluteColumns);
  d31?.addEventListener('input',  updateFluteColumns);
  if (window.jQuery && jQuery.fn && jQuery.fn.select2 && d31) {
    jQuery(d31).on('change.select2', updateFluteColumns);
  }
})();
</script>

<style>
  .form-check-inline .form-check-input{margin-inline:.25rem;}
  .form-check-inline{margin-bottom:0}
</style>
{% endblock %}
