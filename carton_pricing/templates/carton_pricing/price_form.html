{% extends "base.html" %}
{% load static %}

{% block content %}
<h3 class="mb-3">فرم قیمت</h3>

{# پیام‌ها #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">{{ message }}</div>
  {% endfor %}
{% endif %}

{# خطاها #}
{% if errors or form.non_field_errors %}
  <div class="alert alert-danger" role="alert">
    <strong>خطا در محاسبه/اعتبارسنجی:</strong>
    <ul class="mt-2 mb-0">
      {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
      {% if errors %}
        {% for field, errs in errors.items %}
          {% if field == '__all__' %}
            {% for e in errs %}<li>{{ e }}</li>{% endfor %}
          {% else %}
            <li><strong>{{ field }}:</strong>
              <ul class="mb-0">{% for e in errs %}<li>{{ e }}</li>{% endfor %}</ul>
            </li>
          {% endif %}
        {% endfor %}
      {% endif %}
    </ul>
  </div>
{% endif %}

<form method="post" id="priceForm" class="card card-body shadow-sm mb-4" dir="rtl" novalidate>
  {% csrf_token %}
  <input type="hidden" name="stage" id="stageField" value="{{ ui_stage|default:'s1' }}"/>

  <div class="row g-3">
    {# ── اطلاعات مشتری ── #}
    <div class="col-md-4">
      <label class="form-label" for="{{ form.customer.id_for_label }}">{{ form.customer.label }}</label>
      {{ form.customer }}
      {% for e in form.customer.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-4">
      <label class="form-label" for="{{ form.contact_phone.id_for_label }}">{{ form.contact_phone.label }}</label>
      {{ form.contact_phone }}
      {% for e in form.contact_phone.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-4">
      <label class="form-label" for="{{ form.prepared_by.id_for_label }}">{{ form.prepared_by.label }}</label>
      {{ form.prepared_by }}
      {% for e in form.prepared_by.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    <div class="col-12 d-flex align-items-center gap-2 flex-wrap">
      <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddCustomer">افزودن مشتری</button>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="btnAddPhone">افزودن شماره تماس</button>
      <span class="ms-2 text-muted" id="lastOrderInfo" aria-live="polite"></span>
    </div>

    <hr class="my-2"/>

    {# ── گزینه‌های چاپ/فنی ── #}
    <div class="col-12">
      <div class="d-flex flex-wrap align-items-center gap-3">
        <label class="form-check mb-0">{{ form.has_print_notes_bool }} {{ form.has_print_notes_bool.label }}</label>

        <label class="form-check mb-0">{{ form.dim_customer }} {{ form.dim_customer.label }}</label>
        <label class="form-check mb-0">{{ form.dim_customer_sample }} {{ form.dim_customer_sample.label }}</label>
        <label class="form-check mb-0">{{ form.dim_sample }} {{ form.dim_sample.label }}</label>

        <label class="form-check mb-0">{{ form.tech_new_cliche }} {{ form.tech_new_cliche.label }}</label>
        <label class="form-check mb-0">{{ form.tech_handle_slot }} {{ form.tech_handle_slot.label }}</label>
        <label class="form-check mb-0">{{ form.tech_punch }} {{ form.tech_punch.label }}</label>
        <label class="form-check mb-0">{{ form.tech_pallet }} {{ form.tech_pallet.label }}</label>
        <label class="form-check mb-0">{{ form.tech_shipping_on_customer }} {{ form.tech_shipping_on_customer.label }}</label>
      </div>
      {% for e in form.has_print_notes_bool.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── مشخصات/ابعاد پایه ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.product_code.id_for_label }}">{{ form.product_code.label }}</label>
      {{ form.product_code }}
      {% for e in form.product_code.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.carton_type.id_for_label }}">{{ form.carton_type.label }}</label>
      {{ form.carton_type }}
      {% for e in form.carton_type.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.carton_name.id_for_label }}">{{ form.carton_name.label }}</label>
      {{ form.carton_name }}
      {% for e in form.carton_name.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.I8_qty.id_for_label }}">{{ form.I8_qty.label }}</label>
      {{ form.I8_qty }}
      {% for e in form.I8_qty.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── A6 ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A1_layers.id_for_label }}">{{ form.A1_layers.label }}</label>
      {{ form.A1_layers }}
      {% for e in form.A1_layers.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A2_pieces.id_for_label }}">{{ form.A2_pieces.label }}</label>
      {{ form.A2_pieces }}
      {% for e in form.A2_pieces.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A3_door_type.id_for_label }}">{{ form.A3_door_type.label }}</label>
      {{ form.A3_door_type }}
      {% for e in form.A3_door_type.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.A4_door_count.id_for_label }}">{{ form.A4_door_count.label }}</label>
      {{ form.A4_door_count }}
      {% for e in form.A4_door_count.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── ابعاد ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.E15_len.id_for_label }}">{{ form.E15_len.label }}</label>
      {{ form.E15_len }}
      {% for e in form.E15_len.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.G15_wid.id_for_label }}">{{ form.G15_wid.label }}</label>
      {{ form.G15_wid }}
      {% for e in form.G15_wid.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label" for="{{ form.I15_hgt.id_for_label }}">{{ form.I15_hgt.label }}</label>
      {{ form.I15_hgt }}
      {% for e in form.I15_hgt.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── لب درب (فقط برای «درب باز») ── #}
    <div class="col-md-3 open-door-extra d-none" id="field-e17-wrap">
      <label class="form-label" for="{{ form.E17_lip.id_for_label }}">{{ form.E17_lip.label }}</label>
      {{ form.E17_lip }}
      {% for e in form.E17_lip.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    <div class="col-md-3 open-door-extra d-none" id="field-open-bottom-door">
      <label class="form-label" for="{{ form.open_bottom_door.id_for_label }}">{{ form.open_bottom_door.label }}</label>
      {{ form.open_bottom_door }}
      {% for e in form.open_bottom_door.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── گام فلوت ── #}
    <div class="col-md-3">
      <label class="form-label" for="{{ form.D31_flute.id_for_label }}">{{ form.D31_flute.label }}</label>
      {{ form.D31_flute }}
      {% for e in form.D31_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── تسویه ── #}
    <div class="col-md-3">
      <label class="form-label d-block">تسویه فاکتور</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="settlement" id="settle_cash" value="cash" checked>
        <label class="form-check-label" for="settle_cash">نقد</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="settlement" id="settle_credit" value="credit">
        <label class="form-check-label" for="settle_credit">مدت‌دار</label>
      </div>

      <div id="creditDaysWrap" class="input-group input-group-sm mt-2 d-none">
        <span class="input-group-text">روز</span>
        <input type="number" min="0" step="1" class="form-control" name="credit_days" id="id_credit_days" placeholder="مثلاً 30">
      </div>

      <div class="d-none">{{ form.payment_type }}</div>
      {% for e in form.payment_type.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    <div class="col-md-3">
      <label class="form-label" for="{{ form.E46_round_adjust.id_for_label }}">{{ form.E46_round_adjust.label }}</label>
      {{ form.E46_round_adjust }}
      {% for e in form.E46_round_adjust.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
    </div>

    {# ── کارت انتخاب عرض ورق ── #}
    {% if best_by_width %}
      <div class="col-12">
        <div class="card mt-2">
          <div class="card-header">انتخاب عرض ورق از بین گزینه‌های مناسب</div>
          <div class="card-body">
            <p class="text-muted mb-2">
              <strong>K15 = {{ result_preview.K15 }}</strong> |
              <strong>E20 = {{ result_preview.E20 }}</strong> |
              <strong>K20 = {{ result_preview.K20 }}</strong><br>
              معیار رنگ: <span class="text-success fw-bold">سبز</span> ⇐ 0 &lt; دورریز &lt; 11 ،
              <span class="text-danger fw-bold">قرمز</span> ⇐ سایر حالات (شامل 0 و 11).
            </p>

            <div class="table-responsive">
              <table class="table table-sm align-middle text-center">
                <thead>
                  <tr>
                    <th>انتخاب</th>
                    <th>(cm) عرض ورق (M24)</th>
                    <th>F24 (≤ 30)</th>
                    <th>(cm) دورریز (I22)</th>
                    <th>(cm²) مصرف کارتن (E28)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in best_by_width %}
                    <tr>
                      <td>
                        <input type="radio" name="sheet_choice" value="{{ r.sheet_width }}"
                               {% if request.POST.sheet_choice %}
                                 {% if request.POST.sheet_choice|floatformat:2 == r.sheet_width|floatformat:2 %}checked{% endif %}
                               {% elif forloop.first %}checked{% endif %}>
                      </td>
                      <td>{{ r.sheet_width|floatformat:0 }}</td>
                      <td>{{ r.f24 }}</td>
                      <td class="{% if r.I22 is not None and r.I22 > 0 and r.I22 < 11 %}text-success fw-bold{% elif r.I22 is not None %}text-danger{% else %}text-muted{% endif %}">
                        {% if r.I22 is not None %}{{ r.I22|floatformat:2 }}{% else %}—{% endif %}
                      </td>
                      <td>{% if r.E28 is not None %}{{ r.E28|floatformat:4 }}{% else %}—{% endif %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <button class="btn btn-outline-primary mt-2" type="submit" data-stage="s1" formnovalidate>محاسبه جدول</button>
          </div>
        </div>
      </div>
    {% endif %}

    {# ── ذخیره رکورد ── #}
    <div class="col-12 form-check mt-2">
      {{ form.save_record }} {{ form.save_record.label_tag }}
    </div>

    {# ── دکمه محاسبه نهایی ── #}
    <div class="col-12">
      <div class="d-flex align-items-center gap-3">
        <button id="btnSubmit" class="btn btn-primary" type="submit" data-stage="final">
          <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          محاسبه نهایی
        </button>
      </div>
    </div>

    {# ── ترکیب کاغذ ── #}
    <div class="col-12">
      <div class="card mt-2">
        <div class="card-header">ترکیب کاغذ</div>
        <div class="card-body row g-3">
          <div class="col-md-4">
            <label class="form-label" for="{{ form.pq_glue_machine.id_for_label }}">{{ form.pq_glue_machine.label }}</label>
            {{ form.pq_glue_machine }}
            {% for e in form.pq_glue_machine.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            <label class="form-label" for="{{ form.pq_be_flute.id_for_label }}">{{ form.pq_be_flute.label }}</label>
            {{ form.pq_be_flute }}
            {% for e in form.pq_be_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            <label class="form-label" for="{{ form.pq_middle_layer.id_for_label }}">{{ form.pq_middle_layer.label }}</label>
            {{ form.pq_middle_layer }}
            {% for e in form.pq_middle_layer.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            <label class="form-label" for="{{ form.pq_c_flute.id_for_label }}">{{ form.pq_c_flute.label }}</label>
            {{ form.pq_c_flute }}
            {% for e in form.pq_c_flute.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            <label class="form-label" for="{{ form.pq_bottom_layer.id_for_label }}">{{ form.pq_bottom_layer.label }}</label>
            {{ form.pq_bottom_layer }}
            {% for e in form.pq_bottom_layer.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
          </div>
        </div>
      </div>
    </div>

  </div>{# /row #}
</form>

{% if ui_stage == 'final' %}
  <div class="card shadow-sm">
    <div class="card-header">نتیجه محاسبات</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2"><strong>A6:</strong> {{ result.A6_sheet_code }}</div>
        <div class="col-md-2"><strong>E20:</strong> {{ result.E20_industrial_len }} cm</div>
        <div class="col-md-2"><strong>K20:</strong> {{ result.K20_industrial_wid }} cm</div>
        <div class="col-md-3"><strong>F24 (تعداد/ورق):</strong> {{ result.F24_per_sheet_count }}</div>
        <div class="col-md-3"><strong>عرض ورق انتخابی:</strong> {{ result.chosen_sheet_width }} cm</div>
        <hr/>
        <div class="col-md-3"><strong>E28 مصرف کارتن:</strong> {{ result.E28_carton_consumption }}</div>
        <div class="col-md-3"><strong>E38 متراژ ورق (m²):</strong> {{ result.E38_sheet_area_m2 }}</div>
        <div class="col-md-3"><strong>I38 تعداد ورق:</strong> {{ result.I38_sheet_count }}</div>
        <div class="col-md-3"><strong>E41 مایه کاری ورق:</strong> {{ result.E41_sheet_working_cost }}</div>
        <div class="col-md-3"><strong>E40 مایه کاری سربار:</strong> {{ result.E40_overhead_cost }}</div>
        <div class="col-md-3"><strong>M40 مایه کاری کلی:</strong> {{ result.M40_total_cost }}</div>
        <div class="col-md-3"><strong>M41 مبلغ سود:</strong> {{ result.M41_profit_amount }}</div>
        <div class="col-md-3"><strong>H46 قیمت بدون مالیات:</strong> {{ result.H46_price_before_tax }}</div>
        <div class="col-md-3"><strong>J48 مالیات:</strong> {{ result.J48_tax }}</div>
        <div class="col-md-3"><strong>E48 قیمت با مالیات:</strong> {{ result.E48_price_with_tax }}</div>
        <div class="col-md-3"><strong>فی ورق (Fee_amount):</strong> {{ fee_amount|default:0|floatformat:2 }}</div>
      </div>
    </div>
  </div>
{% endif %}

<script>
(function () {
  "use strict";

  // ===== helpers =====
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF = getCookie('csrftoken');

  // نمایش/مخفی‌سازی فیلدهای «درب باز»
  function toggleOpenDoorExtras(show) {
    document.querySelectorAll('.open-door-extra').forEach(el=>{
      el.classList.toggle('d-none', !show);
    });
    if(!show){
      ['id_E17_lip','id_open_bottom_door'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
    }
  }

  // تشخیص انتخاب «درب باز» در سلکت A3
  function isOpenDoorSelected() {
    const sel = document.getElementById('id_A3_door_type');
    if(!sel) return false;
    const idx  = sel.selectedIndex;
    const val  = (sel.value || '').trim();
    const text = (sel.options[idx]?.text || '').replace(/\s+/g,'').trim();
    return val === '1' || idx === 1 || text === 'دربباز';
  }

  function updateByA3() { toggleOpenDoorExtras(isOpenDoorSelected()); }

  // تسویه: نمایش روزهای مدت‌دار + همگام‌سازی payment_type
  function syncSettlementUI(){
    const cash = document.getElementById('settle_cash').checked;
    const sel  = document.getElementById('id_payment_type');
    if(sel) sel.value = cash ? 'cash' : 'credit';
    document.getElementById('creditDaysWrap').classList.toggle('d-none', cash);
  }

  // --- رویدادها ---
  const a3 = document.getElementById('id_A3_door_type');
  a3?.addEventListener('change', updateByA3);
  a3?.addEventListener('input', updateByA3);
  if (window.jQuery && jQuery.fn && jQuery.fn.select2 && a3) {
    jQuery(a3).on('change.select2', updateByA3);
  }

  document.getElementById('settle_cash').addEventListener('change', syncSettlementUI);
  document.getElementById('settle_credit').addEventListener('change', syncSettlementUI);

  // ذخیره مرحله ارسال
  const stageField = document.getElementById('stageField');
  document.querySelectorAll('button[type="submit"][data-stage]').forEach(btn=>{
    btn.addEventListener('click', ()=> { if(stageField) stageField.value = btn.dataset.stage; });
  });

  // UX ارسال
  const btnSubmit = document.getElementById('btnSubmit');
  const btnSpinner = document.getElementById('btnSpinner');
  document.getElementById('priceForm')?.addEventListener('submit', ()=>{
    btnSpinner?.classList.remove('d-none');
    btnSubmit?.setAttribute('disabled','disabled');
  });

  // درخواست «آخرین سفارش» بعد از انتخاب مشتری
  const customerSel = document.getElementById('id_customer');
  const lastInfo = document.getElementById('lastOrderInfo');
  async function fetchLast(){
    if(!customerSel?.value) return;
    try{
      const r = await fetch("{% url 'carton_pricing:api_last_order' %}", {
        method:'POST',
        headers:{'X-CSRFToken': CSRF,'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({customer_id: customerSel.value})
      });
      const d = await r.json();
      const data = d.data || {};
      lastInfo.textContent = (d.ok && data)
        ? `آخرین سفارش: تاریخ ${data.last_date || '—'} | فی ${data.last_fee || '—'} | نرخ ${data.last_rate || '—'}`
        : 'آخرین سفارشی یافت نشد';
    }catch(e){}
  }
  customerSel?.addEventListener('change', fetchLast);

  // افزودن سریع مشتری/شماره
  async function quickAddCustomer(){
    const help = `ورودی را اینطور بده (با ویرگول):
نام, نام‌خانوادگی, شرکت/مجموعه, شماره تماس, برچسب تماس, شماره اقتصادی, آدرس`;
    const all = prompt(help) || '';
    const p = all.split(',').map(s => s.trim());
    if(!p[0]) return;
    const [first_name, last_name='', organization='', phone='', phone_label='', economic_no='', address=''] = p;
    try{
      const res = await fetch("{% url 'carton_pricing:api_add_customer' %}", {
        method:'POST',
        headers:{'X-CSRFToken': CSRF,'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({first_name,last_name,organization,economic_no,address})
      });
      const data = await res.json();
      if(!data.ok){ alert('خطا در افزودن مشتری'); return; }
      const opt = new Option(data.text, data.id, true, true);
      customerSel.add(opt); customerSel.value = data.id;
      if(phone){
        try{
          const r2 = await fetch("{% url 'carton_pricing:api_add_phone' %}", {
            method:'POST',
            headers:{'X-CSRFToken': CSRF,'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded'},
            body:new URLSearchParams({customer:data.id, number:phone, label:phone_label||''})
          });
          const d2 = await r2.json();
          const phoneInput = document.getElementById('id_contact_phone');
          if(d2.ok && phoneInput && !phoneInput.value) phoneInput.value = d2.text;
        }catch{}
      }
      fetchLast();
    }catch{ alert('اشکال در اتصال'); }
  }
  async function quickAddPhone(){
    if(!customerSel?.value){ alert('ابتدا مشتری را انتخاب کنید'); return; }
    const number = prompt('شماره تماس'); if(!number) return;
    const label = prompt('برچسب')||'';
    try{
      const res = await fetch("{% url 'carton_pricing:api_add_phone' %}", {
        method:'POST',
        headers:{'X-CSRFToken': CSRF,'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({customer:customerSel.value, number, label})
      });
      const data = await res.json();
      if(data.ok){
        const phoneInput = document.getElementById('id_contact_phone');
        if(phoneInput && !phoneInput.value) phoneInput.value = data.text;
        else alert('ثبت شد: ' + data.text);
      }else{
        alert('خطا در افزودن شماره');
      }
    }catch{ alert('اشکال در اتصال'); }
  }
  document.getElementById('btnAddCustomer')?.addEventListener('click', quickAddCustomer);
  document.getElementById('btnAddPhone')?.addEventListener('click', quickAddPhone);

  // اجرای اولیه
  window.addEventListener('load', ()=>{
    updateByA3();
    fetchLast();
    syncSettlementUI();
  });
})();
</script>

<style>
  .form-check-inline .form-check-input{margin-inline:.25rem;}
  .form-check-inline{margin-bottom:0}
</style>
{% endblock %}
